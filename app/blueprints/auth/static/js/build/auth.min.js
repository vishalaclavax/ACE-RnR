$(function() {
    $.validator.addMethod("accept", function (value, element)
    {
        return this.optional(element) || /^[a-zA-Z-,]+(\s{0,1}[a-zA-Z-,.!_@ ])*$/.test(value);
    }, "Letters and spaces only please");

    $.validator.addMethod("email", function (value, element)
    {
        return this.optional(element) || /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(value);
    }, "Please enter a valid email");

    $.validator.addMethod("noSpace", function(value, element) {
        return value.indexOf(" ") < 0 && value != "";
    }, "No space please");

    $.validator.addMethod("acceptcharacters", function (value, element)
    {
        return this.optional(element) || /^[a-zA-Z-,]+(\s{0,1}[a-zA-Z-,.!_@ ])*$/.test(value);
    }, "please enter only character");

    $.validator.addMethod("validate_email", function(value, element) {
        if (/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(value)) {
            return true;
        } else {
            return false;
        }
    }, "Please enter a valid email");
    $.validator.addMethod("password_pattern", function (value, element) {
        console.log("from validator");
        console.log(value);
        let password = value;
        if (!(/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[@#$%&])(.{8,15}$)/.test(password))) {
            return false;
        }
        return true;
    }, function (value, element) {
        let password = $(element).val();
        if (!(/^(.{8,15}$)/.test(password))) {
            return 'Password must be between 8 to 15 characters long.';
        }
        else if (!(/^(?=.*[A-Z])/.test(password))) {
            return 'Password must contain at least one uppercase.';
        }
        else if (!(/^(?=.*[a-z])/.test(password))) {
            return 'Password must contain at least one lowercase.';
        }
        else if (!(/^(?=.*[0-9])/.test(password))) {
            return 'Password must contain at least one digit.';
        }
        else if (!(/^(?=.*[@#$%&])/.test(password))) {
            return "Password must contain special characters from @#$%&.";
        }else{
            return true;
        }
        return false;
    });
    var queryString = urlState.search();
    if (queryString.popup && $('#' + queryString.popup).length) {
        app.showModal($('#' + queryString.popup));
        var index_page = $('#index-page').val();
        if (index_page != '') {
            $('#' + queryString.popup).find('#next_page').val(index_page);
        }
    }

    $('#modal_login').on('show.bs.modal', function(evt) {
        $('form#login_form').validate().resetForm();
        var $modal = $(this);
        if (evt.relatedTarget) {
            var $button = $(evt.relatedTarget);
            var redirectPath = $button.data('redirectPath');
            var index_page = $('#index-page').val();
            if (index_page != '' && index_page != 'undefined' && index_page != null) {
                redirectPath = index_page
            }
            if (redirectPath) {
                $modal.find('#next_page').val(redirectPath);
            } else {
                $modal.find('#next_page').val('');
            }
        } else {
            $modal.find('#next_page').val('');
        }
    });

    $('#modal_signup').on('show.bs.modal', function(evt) {
        $('form#signup_form_popup').validate().resetForm();
        $('#check_alert').hide();
    });

    $('#modal_OTP_CreateAccount').on('show.bs.modal', function(evt) {
        $('form#signup_form_popup').validate().resetForm();
        var $modal = $(this);
        $.ajax({
            type: 'GET',
            url: app.config.get('tmp_session_url'),
            dataType: 'json',
            cache: false,
            success: function(data, status, xhr) {
                $modal.find('#masked-mobile').text('******' + (data.mobile || 'XXXXXXXXXX').substr(6))
            },
        });
    }).on('hide.bs.modal', function(evt) {
        $(this).find('#masked-mobile').text('XXXXXXXXXX');
    });


    // $(".forget-link").click(function(e) {
    //     var forgetPass = true;
    //     $(".modal").modal("hide");
    //     app.showModal($('#model_ForgotPassword'));
    //     // $('#modal_login').on('hidden.bs.modal', function (e) {
    //     //     if(forgetPass) {
    //     //         app.showModal($('#model_ForgotPassword'));
    //     //     }
    //     //     forgetPass = false;
    //     // });
    // });


    $("#signup-link , #registerAgain").click(function(e) {
        var signup = true;
        $(".modal").modal("hide");
        app.showModal($('#modal_signup'));
        // $('#modal_login').on('hidden.bs.modal', function (e) {
        //     if(signup) {
        //         app.showModal($('#modal_signup'));
        //     }
        //     signup = false;
        // });
    });



    $('form#login_form').on('submit', function(evt) {
            if(!$('form#login_form').valid()){
                return false;
            }
            evt.preventDefault();
            var form = this;
            var $form = $(this);
            // console.log(app.config.get('auto_login_url'))
            var $button = $form.find('[type="submit"]');
            var $msgContainer = $form.find('#flash_msg');
            var pass = $form.find('input#password').val();
            var email = $form.find('input#email').val();

            // var encodedata = btoa(pass);
            var $input_type = $form.find('#password')
            var is_xhr = $form.find('[name="is_xhr"]').val();
            var next_page = $("#next_page").val();
           
            $button.attr("disabled", "disabled");
            $formData = {'csrf_token': $form.find('[name="csrf_token"]').val(),'is_xhr':is_xhr,'next_page':next_page, 'password': pass,'email':email},

            $input_type.attr("type", "password");
            $msgContainer.show();
            
            $.ajax({
                url: $form.attr('action'),
                type: $form.attr('method') || 'POST',
                cors: true ,
                data: $formData,
                secure: true,
                headers: {
                    'Access-Control-Allow-Origin': '*',},
                dataType: 'json',
                cache: false,
                beforeSend: function(xhr, settings) {
                    $button.button('loading');
                    app.flashMsg('Authenticating...', 'info', $msgContainer);
                    $form.find('.form-group').removeClass('has-error');
                },
                success: function(data, status, xhr) {
                    if (data['success']) {
                        app.flashMsg('Authentication successful. Redirecting...', 'success', $msgContainer);
                        window.location.href=data.url;
                        // if (data.error) {
                        //     $button.button('reset');
                        //     $form.find('input#password').val('');
                        //     app.flashMsg(data.error, 'error', $msgContainer);
                        //     $form.find('.form-group').addClass('has-error');
                        // } else {
                        //     app.flashMsg('Authentication successful. Redirecting...', 'success', $msgContainer);
                        //     var loginCallback = app.config.get('loginCallback')
                        //     if (typeof loginCallback === 'function') {
                        //         loginCallback()
                        //     } else {
                        //         window.location.assign(data.redirect || "{{ url_for('main.index') }}");
                        //     }
                        // }
                    } else {
                        $button.attr("disabled", false);
                        $form.find('input#password').val('');
                        app.flashMsg(data.error, 'error', $msgContainer);
                    }
                },
                error: function(status, err) {
                    console.log(err);
                    $button.attr("disabled", false);
                    $form.find('input#password').val('');
                    app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                },
            });
          
    });

    $('#register_form').validate({
            errorElement: 'span',
            ignore: [],
            rules: {
                first_name:{
                    required: true,
                    acceptcharacters: true,
                    noSpace:true
                },
                last_name:{
                    required: true,
                    acceptcharacters: true,
                    noSpace:true
                },
                email:{
                    required:true,
                    validate_email:true,
                },
                password:{
                    required:true,
                    password_pattern:true,
                    minlength:8,
                    maxlength:15,   
                }
            },
            messages: {
                first_name:{
                    required: "First Name is required",
                    acceptcharacters: "Please enter Valid first name",
                    noSpace:"Please enter Valid first name"
                },
                last_name:{
                    required: "Last Name is required",
                    acceptcharacters: "Please enter Valid last name",
                    noSpace:"Please enter Valid last name"
                },
                email:{
                    required: "Email is required",
                    validate_email: "Please enter Valid email"
                },
                password:{
                    required: "Password is required",
                    minlength: "Please enter atleast 8 character",
                    maxlength:"please enter atmost 15 character",
                }
            },
            errorPlacement: function(error, element) {
                if(element.hasClass('agent_state') || element.hasClass('agent_status')){
                    error.insertAfter(element.next('.chosen-container'));
                }else{
                    error.insertAfter(element);
                }
            }
    });


    $('#checkout-form').validate({
        errorElement: 'p',
        ignore: [],
        rules: {
            name:{
                required: true,
                acceptcharacters: true
            },
            email:{
                required:true,
                validate_email:true,
            },
            mobile:{
                required: true,
                number: true,
                noSpace:true,
                minlength: 10,
                maxlength: 12
            },
            address:{
                required:true,
            },
            state:{
                required: true,
                acceptcharacters: true
            },
            city:{
                required: true,
                acceptcharacters: true
            },
            pincode:{
                required: true,
                number: true,
                noSpace:true,
                minlength:6,
                maxlength:6,
            }
        },
        messages: {
            name:{
                required: "Pleas enter full name",
                acceptcharacters: "Please enter Valid name",
            },
            email:{
                required: "Email is required",
                validate_email: "Please enter Valid email"
            },
            mobile:{
                required: "mobile Number is required",
                noSpace: "Do not enter spaces",
                minlength: "Please number must be at least 10 numbers",
                maxlength: "Please number must be at least 10 numbers"
            },
            address:{
                required: "Address is required"
            },
            state:{
                required: "State is required"
            },
            city:{
                required: "City is required"
            },
            pincode:{
                required: "pincode is required",
                minlength: "Please enter atleast 6 character",
                maxlength:"please enter atmost 6 character",   
            }
        },
        errorPlacement: function(error, element) {
            if(element.hasClass('agent_state') || element.hasClass('agent_status')){
                error.insertAfter(element.next('.chosen-container'));
            }else{
                error.insertAfter(element);
            }
        },
        submitHandler: function(form) {
            console.log('invalid submitHandler');
            form.submit();
        }
    });

    $('#myAccount-form').validate({
        errorElement: 'p',
        ignore: [],
        rules: {
            complete_name:{
                required: true,
                acceptcharacters: true
            },
            email:{
                required:true,
                validate_email:true,
            },
            mobile:{
                required: true,
                number: true,
                noSpace:true,
                minlength: 10,
                maxlength: 10
            }
        },
        messages: {
            complete_name:{
                required: "Pleas enter first name",
                acceptcharacters: "Please enter Valid name",
            },            
            email:{
                required: "Email is required",
                validate_email: "Please enter Valid email"
            },
            mobile:{
                required: "Phone Number is required",
                noSpace: "Do not enter spaces",
                minlength: "Please number must be at least 10 numbers",
                maxlength: "Please number must be at least 10 numbers"
            }
        },
        errorPlacement: function(error, element) {
            if(element.hasClass('agent_state') || element.hasClass('agent_status')){
                error.insertAfter(element.next('.chosen-container'));
            }else{
                error.insertAfter(element);
            }
        },
        submitHandler: function(form) {
            console.log('invalid submitHandler');
            form.submit();
        }
    });


    $('#login_form').validate({
        errorElement: 'p',
        ignore: [],
        rules: {
            email:{
                required:true,
                validate_email:true,
            },
            password:{
                required:true
            }
        },
        messages: {
            email:{
                required: "Email is required",
                validate_email: "Please enter Valid email"
            },
            password:{
                required: "Password is required"
            }
        },
        errorPlacement: function(error, element) {
            if(element.hasClass('agent_state') || element.hasClass('agent_status')){
                error.insertAfter(element.next('.chosen-container'));
            }else{
                error.insertAfter(element);
            }
        }
    });

    $('#update-password').validate({
        errorElement: 'p',
        ignore: [],
        rules: {
            newPassword:{ 
                required:true,
                password_pattern:true,
                minlength:8,
                maxlength:15,
            },
            confirmPassword:{
                required:true,
                minlength:8,
                equalTo:"#newPassword"

            }
        },
        messages: {
            newPassword:{
                required: "Password is required",
                minlength: "Password length must be greater than 8 characters.",
                maxlength:"please enter atmost 15 character", 
            },
            confirmPassword:{
                required: "Password is required",
                minlength: "Password length must be greater than 8 characters.",
                equalTo:"Password is not same new password"  
            }
        },
        errorPlacement: function(error, element) {
            if(element.hasClass('agent_state') || element.hasClass('agent_status')){
                error.insertAfter(element.next('.chosen-container'));
            }else{
                error.insertAfter(element);
            }
        },
        submitHandler: function(){
            if(!$('#update-password').valid()) {
                return false;
            }else{
                var p = $("#update-password #newPassword").val();
                $("#update-password #newPassword").val(btoa(p));
                var cp = $("#update-password #confirmPassword").val();
                $("#update-password #confirmPassword").val(btoa(cp));
                return true;
            }
        }
    });

    
    $('form#register_form').on('submit', function(evt) {
        if(!$('form#register_form').valid()){
            return false;
        }
        evt.preventDefault();
        var form = this;
        var $form = $(this);
        // console.log(app.config.get('auto_login_url'))
        var $button = $form.find('[type="submit"]');
        var $msgContainer = $form.find('#flash_msg');
        var first_name = $form.find('input#first_name').val();
        var last_name = $form.find('input#last_name').val();
        var pass = $form.find('input#register_password').val();
        var email = $form.find('input#email').val();

        // var encodedata = btoa(pass);
        var $input_type = $form.find('#register_password')
        var is_xhr = $form.find('[name="is_xhr"]').val();
        var next_page = $("#next_page").val();
       
        $button.attr("disabled", "disabled");
        $formData = {'csrf_token': $form.find('[name="csrf_token"]').val(),'is_xhr':is_xhr,'next_page':next_page, 'password': pass,'email':email,'first_name':first_name,'last_name':last_name},'',

        $input_type.attr("type", "password");
        $msgContainer.show();
        
        $.ajax({
            url: $form.attr('action'),
            type: $form.attr('method') || 'POST',
            data : $formData ,
            dataType: 'json',
            cache: false,
            beforeSend: function(xhr, settings) {
                $button.button('loading');
                app.flashMsg('Authenticating...', 'info', $msgContainer);
                $form.find('.form-group').removeClass('has-error');
            },
            success: function(data, status, xhr) {
                if (data['success']) {
                    app.flashMsg('Your account created successfully.. Redirecting...', 'success', $msgContainer);
                    window.location.href=data.url;
                } else {
                    $button.attr("disabled", false);
                    $form.find('input#password').val('');
                    app.flashMsg(data.error, 'error', $msgContainer);
                }
            },
            error: function(status, err) {
                console.log(err);
                $button.attr("disabled", false);
                $form.find('input#password').val('');
                app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
            },
        });
      
});

    $('#check_alert').hide();
    var checked = false
    $('#register_tnc').on('change', function(e) {
        checked = $(this).prop("checked")
        if ($(this).prop("checked") == true) {
            $('#check_alert').hide();
        }

    });
    $('form#signup_form_popup').on('submit', function(evt) {
        if (checked === false) {
            $('#check_alert').show();
            $('#check_alert').css('color', 'red')
        }

        if ($('form#signup_form_popup').valid() && checked) {
            evt.preventDefault();
            var $form = $(this);
            var $msgContainer = $form.find('#flash_msg');
            var $button = $form.find('[type="submit"]');
            var $signupModal = $form.closest('.modal');
            var $otpModal = $('#modal_OTP_CreateAccount');

            var first_8_digit = $form.find("#first_8_digit").val();
            var last_4_digit = $form.find("#last_4_digit").val();
            var mobile = btoa($form.find("#mobile").val());

            var customer_id = $form.find("#customer_id_signup").val();
            var encode_customer_id = btoa(customer_id);
            var encode_first_8_digit = btoa(first_8_digit);
            var encode_last_4_digit = btoa(last_4_digit);
            var using_debit_card = $form.find("#using_debit_card").val();
            var dial_code  = btoa($form.find("#dial-code").val());
            var is_xhr = $form.find('[name="is_xhr"]').val();
            var register_tnc = $form.find('#register_tnc').val();

//            if ($('.check_zero').filter(function() {
//                    return parseInt(this.value, 10) !== 0;
//                }).length === 0) {
//                app.flashMsg('Invalid Customer Id', 'error', $msgContainer, 10);
//                return false;
//            }

            // var $input_type = $form.find('#createPassword')

            // var pass = $form.find('input#createPassword').val();
            // var encodedata = btoa(pass);

            // $form.find('input#createPassword').val(encodedata);
            // $input_type.attr("type", "password");
            $formData = {'csrf_token': $form.find('[name="csrf_token"]').val(),'is_xhr':is_xhr, 'customer_id': encode_customer_id ,'first_8_digit':encode_first_8_digit, 'last_4_digit':encode_last_4_digit, 'dial_code':dial_code,'mobile':mobile,'tnc_accepted':register_tnc},


            $otpModal.find('.nextPopupId').val('#model_ForgotPassword');
            $otpModal.find('#isSignup').val(1);
            // $otpModal.find('#popup_heading').html('Create New Password');
            $.ajax({
                type: $form.attr('method') || 'POST',
                url: $form.attr('action'),
                data: $formData,
                dataType: 'json',
                cache: false,
                beforeSend: function(xhr, settings) {
                    $button.prop('disabled', true);
                    app.flashMsg('Requesting...', 'info', $msgContainer, 90);
                },
                success: function(data, status, xhr) {
                    if (status == 'success') {
                        if (data.error) {
                            app.flashMsg(data.error || 'Error!', 'error', $msgContainer);
                            $form.find('input#createPassword').val('');
                        } else {
                            app.flashMsg('OTP has been sent to your mobile.', 'success', $otpModal.find('#flash_msg'));
                            $signupModal.modal('hide');
                            app.showModal($otpModal);
                        }
                    } else {
                        app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                        $form.find('input#createPassword').val('');
                    }
                    $button.prop('disabled', false);
                },
                error: function(xhr, status, err) {
                    $form.find('input#createPassword').val('');
                    console.log(err);
                    $button.prop('disabled', false);
                    app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                },
            });
            return false;
        } else {
            return false;
        }
    });


    $('form#form_verifyotp').on('submit', function(evt) {
        evt.preventDefault();
        var $form = $(this);
        var $msgContainer = $form.find('#flash_msg');
        var $button = $form.find('[type="submit"]');
        var $otpModal = $form.closest('.modal');
        var nextPopupId = $otpModal.find('.nextPopupId').val();
        var isSignup = $otpModal.find('#isSignup').val();
        var $profileModal = $msgContainer;
        if (nextPopupId != '') {
            var $profileModal = $(nextPopupId);
        }

        if (isSignup == '1') { $("#popup_heading").html("Create Your Password"); } else { $("#popup_heading").html("Forgot Password?"); }

        $.ajax({
            type: $form.attr('method') || 'POST',
            url: $form.attr('action'),
            data: $form.serialize(),
            dataType: 'json',
            cache: false,
            beforeSend: function(xhr, settings) {
                $button.prop('disabled', true);
                app.flashMsg('Requesting...', 'info', $msgContainer);
            },
            success: function(data, status, xhr) {
                if (status == 'success') {
                    if (!data.success) {
                        $("#form_verifyotp").trigger("reset");
                        app.flashMsg(data.message || 'Error!', 'error', $msgContainer);
                    } else {
                        if (nextPopupId != '') {
                            app.flashMsg('Mobile number verified. Update your password..', 'success', $profileModal.find('#flash_msg'));
                            $otpModal.modal('hide');
                            app.showModal($profileModal);
                        } else {
                            app.flashMsg('Logging you in...', 'success', $profileModal.find('#flash_msg'));
                            $otpModal.modal('hide');
                            evt.stopImmediatePropagation();
                            window.location.assign(app.config.get('auto_login_url') + '?_=' + $.now());
                        }
                        return false;
                    }
                } else {
                    $("#form_verifyotp").trigger("reset");
                    app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                }
                $button.prop('disabled', false);
            },
            error: function(xhr, status, err) {
                console.log(err);
                $button.prop('disabled', false);
                $("#form_verifyotp").trigger("reset");
                app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
            },
        });
        return false;
    });


    $('.resendOtp').on('click', function(evt) {
        evt.preventDefault();
        var $this = $(this);
        var popId = $(this).data('popupId');
        var $form = $("#" + popId);
        var $msgContainer = $form.find('#flash_msg');
        var isSignup = $("#isSignup").val();
        var countResendOtp = parseInt($('#CountResendOtp').val());
        countResendOtp = parseInt(countResendOtp) + 1;
        $('#CountResendOtp').val(countResendOtp);
        $this.css("pointer-events", "none");

        $.ajax({
            type: 'POST',
            url: $(this).data('actionUrl'),
            data: { csrf_token: $form.find('[name="csrf_token"]').val(), 'countResendOtp': countResendOtp, 'isSignup': isSignup },
            dataType: 'json',
            cache: false,
            beforeSend: function(xhr, settings) {
                app.flashMsg('Requesting...', 'info', $msgContainer);
            },
            success: function(data, status, xhr) {
                if (status == 'success') {
                    if (!data.success) {
                        app.flashMsg(data.message || 'Error!', 'error', $msgContainer);
                    } else {
                        app.flashMsg('OTP has been sent to your mobile.', 'success', $msgContainer);
                        $('input[name="otp"]').val('')
                    }
                } else {
                    app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                }
            },
            error: function(xhr, status, err) {
                app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
            },
        }).done(function() {
            $this.css("pointer-events", "");
        });
        return false;
    });


    $('.open_OTP_CreateAccount').click(function(evt) {
        // evt.preventDefault();
        // var $form = $(this).closest('form');
        // var $msgContainer = $form.find('#flash_msg');
        // var $button = $form.find('[type="submit"]');
        // var $signupModal = $form.closest('.modal');
        // var $otpModal = $('#modal_OTP_CreateAccount');
        // $otpModal.find('.nextPopupId').val('');
        // $msgContainer.show();
        // $.ajax({
        //     type: $form.attr('method') || 'POST',
        //     url: $(this).data('url'),
        //     data: $form.serialize(),
        //     dataType: 'json',
        //     cache: false,
        //     beforeSend: function (xhr, settings) {
        //         $button.prop('disabled', true);
        //         app.flashMsg('Requesting...', 'info', $msgContainer);
        //     },
        //     success: function (data, status, xhr) {
        //         if (status == 'success') {
        //             if (data.error) {
        //                 app.flashMsg(data.error || 'Error!', 'error', $msgContainer);
        //             } else {
        //                 app.flashMsg('OTP has been sent to your mobile.', 'success', $otpModal.find('#flash_msg'));
        //                 $signupModal.modal('hide');
        //                 app.showModal($otpModal);
        //             }
        //         } else {
        //             app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
        //         }
        //         $button.prop('disabled', false);
        //     },
        //     error: function (xhr, status, err) {
        //         console.log(err);
        //         $button.prop('disabled', false);
        //         app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
        //     },
        // });
        // return false;
    });


    $('form#form_ForgotPassword').on('submit', function(evt) {
        // evt.preventDefault();
        // var $form = $(this);
        // var $msgContainer = $form.find('#flash_msg');
        // var $button = $form.find('[type="submit"]');
        // var $signupModal = $form.closest('.modal');
        // var $otpModal = $('#modal_OTP_CreateAccount');
        // $otpModal.find('.nextPopupId').val('');
        // $.ajax({
        //     type: $form.attr('method') || 'POST',
        //     url: $form.attr('action'),
        //     data: $form.serialize(),
        //     dataType: 'json',
        //     cache: false,
        //     beforeSend: function (xhr, settings) {
        //         $button.prop('disabled', true);
        //         app.flashMsg('Requesting...', 'info', $msgContainer);
        //     },
        //     success: function (data, status, xhr) {
        //         if (status == 'success') {
        //             if (data.error) {
        //                 app.flashMsg(data.error || 'Error!', 'error', $msgContainer);
        //             } else {
        //                 app.flashMsg('OTP has been sent to your mobile.', 'success', $otpModal.find('#flash_msg'));
        //                 $signupModal.modal('hide');
        //                 app.showModal($otpModal);
        //             }
        //         } else {
        //             app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
        //         }
        //         $button.prop('disabled', false);
        //     },
        //     error: function (xhr, status, err) {
        //         console.log(err);
        //         $button.prop('disabled', false);
        //         app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
        //     },
        // });
        // return false;
    });


    $('form#form_resetPassword').on('submit', function(evt) {
        evt.preventDefault();
        var $form = $(this);
        var $msgContainer = $form.find('#flash_msg');
        var $button = $form.find('[type="submit"]');
        var $profileModal = $form.closest('.modal');
        var $signinModal = $('#modal_login');
        $otpModal = $('#modal_OTP_CreateAccount');
        var isSignup = $otpModal.find('#isSignup').val();
        var newPassword = $('#newPassword').val()
        var confirmPassword = $('#confirmPassword').val()

        var encode_password = btoa(newPassword);
        var encode_confirm_password = btoa(confirmPassword);


        $(".is_Signup").val(isSignup);
        $.ajax({
            type: $form.attr('method') || 'POST',
            url: $form.attr('action'),
            data: {'isSignup':isSignup,'csrf_token':$form.find('[name="csrf_token"]').val(),'password':encode_password,'confirm_password':encode_confirm_password},
            dataType: 'json',
            cache: false,
            beforeSend: function(xhr, settings) {
                $button.prop('disabled', true);
                app.flashMsg('Requesting...', 'info', $msgContainer);
            },
            success: function(data, status, xhr) {
                if (status == 'success') {
                    if (!data.success) {
                        $form.find('input#password').val('');
                        app.flashMsg(data.message || 'Error!', 'error', $msgContainer);
                    } else {
                        if (isSignup == '1') {
                            app.flashMsg('Password Created Successfully! Logging you in...', 'success', $profileModal.find('#flash_msg'));
                            $otpModal.modal('hide');
                            evt.stopImmediatePropagation();
                            window.location.assign(app.config.get('auto_login_url') + '?_=' + $.now());
                        } else {
                            app.flashMsg('Password changed successfully. Please login to continue.', 'success', $signinModal.find('#flash_msg'));
                            $profileModal.modal('hide');
                            app.showModal($signinModal);
                        }
                    }
                } else {
                    $form.find('input#password').val('');
                    app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                }
                $button.prop('disabled', false);
            },
            error: function(xhr, status, err) {
                console.log(err);
                $button.prop('disabled', false);
                $form.find('input#password').val('');
                app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
            },
        });
        return false;
    });


    $('.forget-link').click(function(evt) {
        evt.preventDefault();
        $this = $(this);
        var $form = $(this).closest('form');
        $this.css("pointer-events", "none");
        var validator = $form.validate();
        validator.resetForm();
        var $msgContainer = $form.find('#flash_msg');
        var $button = $form.find('[type="submit"]');
        var $signupModal = $form.closest('.modal');
        var $otpModal = $('#modal_OTP_CreateAccount');
        var customer_id = $("#customer_id").val();
        var csrf_token = $("#csrf_token").val();
        var is_xhr = $("#is_xhr").val();


        var encode_customer_id = btoa(customer_id);
        var resetOtpCount = $('#resetOtpCount').val();
        resetOtpCount = parseInt(resetOtpCount) + 1;
        $('#resetOtpCount').val(resetOtpCount);

        // $otpModal.find('#popup_heading').html('Forgot Password?');
        $otpModal.find('.nextPopupId').val('#model_ForgotPassword');
        $otpModal.find('#isSignup').val(0);
        $msgContainer.show();
        $.ajax({
            type: $form.attr('method') || 'POST',
            url: $(this).data('url'),
            data: {'is_xhr':$form.find('[name="is_xhr"]').val(),'csrf_token':$form.find('[name="csrf_token"]').val(),'customer_id':encode_customer_id},
            dataType: 'json',
            cache: false,
            beforeSend: function(xhr, settings) {
                $button.prop('disabled', true);
                app.flashMsg('Requesting...', 'info', $msgContainer);
            },
            success: function(data, status, xhr) {
                if (status == 'success') {
                    if (data.error) {
                        app.flashMsg(data.error || 'Error!', 'error', $msgContainer);
                    } else {
                        app.flashMsg('OTP has been sent to your mobile.', 'success', $otpModal.find('#flash_msg'));
                        $signupModal.modal('hide');
                        app.showModal($otpModal);
                    }
                } else {
                    app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
                }
                $button.prop('disabled', false);
            },
            error: function(xhr, status, err) {
                console.log(err);
                $button.prop('disabled', false);
                app.flashMsg("Something went wrong! Please try again later.", 'error', $msgContainer);
            },
        }).done(function() {
            $this.css("pointer-events", "");
        });
        return false;
    });
});
